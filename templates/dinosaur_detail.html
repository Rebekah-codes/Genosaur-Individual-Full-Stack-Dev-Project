{% extends 'base.html' %}
{% load static %}

{% block content %}
{% if messages %}
  <div class="container mt-3 main-content">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} text-center" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}
{% if error %}
<div class="alert alert-danger text-center">Error: {{ error }}</div>
{% endif %}
{% if not dino %}
<div class="alert alert-danger text-center">Dinosaur not found or an error occurred.</div>
{% endif %}

<div class="container mt-4 main-content" style="max-width: 700px;">
  <div class="row justify-content-center">
    <div class="col-12 mb-4">
      <div class="card shadow-sm text-center" style="background-color:#F5E6C8; color:#6B4F23; border-radius:16px;">
  <div class="card-body main-content">
          {% if dino %}
            <h2 class="card-title">
              {{ dino.name|default:dino.species_name }}
              <button type="button" class="btn btn-link p-0 ms-2" style="vertical-align:middle;" data-bs-toggle="modal" data-bs-target="#editNameModal">
                <i class="bi bi-pencil" style="font-size:1.1em; color:orange;"></i>
              </button>
            </h2>
            <p class="lead">{{ dino.species_name }}</p>
            <p>
              <strong>Stage:</strong> {{ dino.stage }}<br>
              <strong>Mood:</strong> {{ dino.mood }}
            </p>
            <img src="{% static dino.image_path %}"
              alt="{{ dino.stage }} sprite"
              class="img-fluid mb-3 evolve-sprite"
              style="max-width: 200px;">
          {% else %}
            <img src="{% static 'images/eggs/green_egg_optimized_.webp' %}"
              alt="Fallback sprite"
              class="img-fluid mb-3 evolve-sprite"
              style="max-width: 200px;">
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card shadow-sm" style="background-color:#F5E6C8; color:#6B4F23; border-radius:16px;">
        <div class="card-body">

    {% if messages %}
      <div class="container mt-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} text-center" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if dino %}
      <!-- Level Progress -->
      <p>Level {{ dino.level }}/100</p>
      <div class="progress mb-4">
        <div class="progress-bar bg-primary" role="progressbar"
          style="width: {{ level_percent }}%"
          aria-valuenow="{{ dino.level }}" aria-valuemin="0" aria-valuemax="100">
          {{ dino.level }}/100
        </div>
      </div>

      <!-- Progress Bars -->
      <h4 class="mt-4">Progression</h4>
      <p>Feeds until evolution ({{ feed_progress }}/{{ feeds_needed }})</p>
      <div class="progress mb-3">
        <div class="progress-bar 
          {% if feed_complete %}bg-success pulse{% elif feed_percent > 66 %}bg-warning{% else %}bg-info{% endif %}"
          role="progressbar"
          style="width: {{ feed_percent }}%"
          aria-valuenow="{{ feed_progress }}" aria-valuemin="0" aria-valuemax="{{ feeds_needed }}">
          {{ feed_progress }}/{{ feeds_needed }}
        </div>
      </div>
      <p>Actions until trait unlock ({{ action_progress }}/{{ actions_needed }})</p>
      <div class="progress mb-4">
        <div class="progress-bar 
          {% if action_complete %}bg-success pulse{% elif action_percent > 66 %}bg-warning{% else %}bg-info{% endif %}"
          role="progressbar"
          style="width: {{ action_percent }}%"
          aria-valuenow="{{ action_progress }}" aria-valuemin="0" aria-valuemax="{{ actions_needed }}">
          {{ action_progress }}/{{ actions_needed }}
        </div>
      </div>
    {% endif %}

    {% if dino %}
      {% if not dino.name %}
      <!-- Dino naming form -->
      <form method="post" action="" class="mb-3">
        {% csrf_token %}
        <div class="mb-2">
          <label for="dino_name" class="form-label">Dinosaur Name:</label>
          <input type="text" id="dino_name" name="dino_name" class="form-control" value="{{ dino.name }}" maxlength="100" placeholder="Give your dinosaur a name...">
        </div>
        <button type="submit" name="set_dino_name" class="btn btn-warning">Set Name</button>
      </form>
      {% endif %}

      <!-- Edit Name Modal -->
      <div class="modal fade" id="editNameModal" tabindex="-1" aria-labelledby="editNameModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editNameModalLabel">Edit Dinosaur Name</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="">
              <div class="modal-body">
                {% csrf_token %}
                <input type="text" id="dino_name_edit" name="dino_name" class="form-control" value="{{ dino.name }}" maxlength="100" placeholder="Edit dinosaur name...">
              </div>
              <div class="modal-footer">
                <button type="submit" name="set_dino_name" class="btn btn-warning">Confirm</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if dino %}
      <!-- Action Form for all stages -->
      <h4>Interact with {{ dino.name }}</h4>
      <form method="POST" action="{% url 'perform_action' dino.id %}" class="mb-4">
        {% csrf_token %}
        <div class="input-group">
          <select name="action_type" class="form-select">
            <option value="feed">Feed</option>
            <option value="play">Play</option>
            <option value="train">Train</option>
          </select>
          <button type="submit" class="btn btn-brown">Do Action</button>
        </div>
      </form>
      {% if dino.stage == 'juvenile' %}
          <!-- Wilderness Search section removed as requested -->
      {% endif %}
    {% endif %}




    {% if dino %}
      <!-- Traits: Only show trait names -->
      <h4 class="mt-4">Traits</h4>
      {% if dino.traits.all %}
        <ul class="list-group mb-3">
          {% for trait in dino.traits.all %}
            <li class="list-group-item">
              <strong>{{ trait.name }}</strong>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No traits unlocked yet.</p>
      {% endif %}

      <!-- Trait Unlock Modal -->
      {% if request.GET.trait_unlocked %}
      <div class="modal fade show" id="traitUnlockModal" tabindex="-1" aria-labelledby="traitUnlockModalLabel" aria-modal="true" style="display:block; background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="traitUnlockModalLabel">Trait Unlocked!</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="document.getElementById('traitUnlockModal').style.display='none';"></button>
            </div>
            <div class="modal-body">
              <strong>{{ request.GET.trait_name }}</strong><br>
              <span>{{ request.GET.trait_description }}</span>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="document.getElementById('traitUnlockModal').style.display='none';">Continue</button>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    {% endif %}

    <!-- Recent Actions -->
    <h4 class="mt-4">Recent Actions</h4>
    {% if actions %}
      <div style="max-height: 300px; overflow-y: auto;">
        <ul class="list-group">
          {% for action in actions %}
            <li class="list-group-item">
              <strong>{{ action.get_action_type_display }}</strong> â†’ {{ action.outcome }}
              <br><small class="text-muted">{{ action.timestamp|date:"M d, Y H:i" }}</small>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <p>No actions yet. Try feeding, playing, or training!</p>
    {% endif %}
    <!-- Release Button -->
    {% if dino %}
      <button type="button" class="btn btn-danger mt-3" data-bs-toggle="modal" data-bs-target="#releaseModal">Release</button>
      <!-- Release Modal -->
      <div class="modal fade" id="releaseModal" tabindex="-1" aria-labelledby="releaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="releaseModalLabel">Release Dinosaur?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Doing this will release your dinosaur back to the wild. This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <form method="post" action="">
                {% csrf_token %}
                <button type="submit" name="release_dino" class="btn btn-danger">Confirm Release</button>
              </form>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
