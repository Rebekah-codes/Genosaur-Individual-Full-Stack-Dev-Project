{% extends 'base.html' %}
{% load static %}

{% block content %}
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} text-center" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}
{% if error %}
<div class="alert alert-danger text-center">Error: {{ error }}</div>
{% endif %}
{% if not dino %}
<div class="alert alert-danger text-center">Dinosaur not found or an error occurred.</div>
{% endif %}

<div class="container mt-4" style="max-width: 700px;">
  <div class="row justify-content-center">
    <div class="col-12 mb-4">
      <div class="card shadow-sm text-center" style="background-color:#F5E6C8; color:#6B4F23; border-radius:16px;">
        <div class="card-body">
          {% if dino %}
            <h2 class="card-title">ðŸ¦• {{ dino.name|default:dino.species_name }}</h2>
            <p class="lead">{{ dino.species_name }}</p>
            <p>
              <strong>Stage:</strong> {{ dino.stage }}<br>
              <strong>Mood:</strong> {{ dino.mood }}
            </p>
            <img src="{% static dino.image_path %}"
              alt="{{ dino.stage }} sprite"
              class="img-fluid mb-3 evolve-sprite"
              style="max-width: 200px;">
          {% else %}
            <img src="{% static 'images/eggs/green_egg.png' %}"
              alt="Fallback sprite"
              class="img-fluid mb-3 evolve-sprite"
              style="max-width: 200px;">
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card shadow-sm" style="background-color:#F5E6C8; color:#6B4F23; border-radius:16px;">
        <div class="card-body">

    {% if messages %}
      <div class="container mt-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} text-center" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if dino %}
      <!-- Level Progress -->
      <p>Level {{ dino.level }}/100</p>
      <div class="progress mb-4">
        <div class="progress-bar bg-primary" role="progressbar"
          style="width: {{ level_percent|default:'0' }}%;"
          aria-valuenow="{{ dino.level }}" aria-valuemin="0" aria-valuemax="100">
          {{ dino.level }}/100
        </div>
      </div>

      <!-- Progress Bars -->
      <h4 class="mt-4">Progression</h4>
      <p>Feeds until evolution ({{ feed_progress }}/{{ feeds_needed }})</p>
      <div class="progress mb-3">
        <div class="progress-bar 
          {% if feed_complete %}bg-success pulse{% elif feed_percent > 66 %}bg-warning{% else %}bg-info{% endif %}"
          role="progressbar"
          style="width: {{ feed_percent|default:'0' }}%;"
          aria-valuenow="{{ feed_progress }}" aria-valuemin="0" aria-valuemax="{{ feeds_needed }}">
          {{ feed_progress }}/{{ feeds_needed }}
        </div>
      </div>
      <p>Actions until trait unlock ({{ action_progress }}/{{ actions_needed }})</p>
      <div class="progress mb-4">
        <div class="progress-bar 
          {% if action_complete %}bg-success pulse{% elif action_percent > 66 %}bg-warning{% else %}bg-info{% endif %}"
          role="progressbar"
          style="width: {{ action_percent|default:'0' }}%;"
          aria-valuenow="{{ action_progress }}" aria-valuemin="0" aria-valuemax="{{ actions_needed }}">
          {{ action_progress }}/{{ actions_needed }}
        </div>
      </div>
    {% endif %}

    {% if dino %}
    <!-- Perform Action Form -->
    <h4>Interact with {{ dino.name }}</h4>
    <form method="POST" action="{% url 'perform_action' dino.id %}" class="mb-4">
      {% csrf_token %}
      <div class="input-group">
        <select name="action_type" class="form-select">
          <option value="feed">Feed</option>
          <option value="play">Play</option>
          <option value="train">Train</option>
        </select>
  <button type="submit" class="btn btn-brown">Do Action</button>
      </div>
    </form>
    {% endif %}

    {% if dino %}
      {% if dino.stage == 'juvenile' %}
        <h4 class="mt-4">Wilderness Search</h4>
        <form method="POST" action="{% url 'perform_action' dino.id %}" class="mb-4">
          {% csrf_token %}
          <input type="hidden" name="action_type" value="wilderness_search">
          <button type="submit" class="btn btn-success">Take {{ dino.name }} to search for food in the wilderness</button>
        </form>
        <p class="text-muted">Juvenile dinosaurs have a 60% chance to find food in the wilderness. Try your luck!</p>
      {% endif %}
    {% endif %}




    {% if dino %}
      <!-- Traits -->
      <h4 class="mt-4">Traits</h4>
      {% if dino.traits.all %}
        <ul class="list-group mb-3">
          {% for trait in dino.traits.all %}
            <li class="list-group-item">
              <strong>{{ trait.name }}</strong> â€” {{ trait.description }}
              {% if trait.mood_impact %}
                <span class="badge bg-info text-dark">{{ trait.mood_impact }}</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No traits unlocked yet.</p>
      {% endif %}
    {% endif %}

    <!-- Recent Actions -->
    <h4 class="mt-4">Recent Actions</h4>
    {% if actions %}
      <div style="max-height: 300px; overflow-y: auto;">
        <ul class="list-group">
          {% for action in actions %}
            <li class="list-group-item">
              <strong>{{ action.get_action_type_display }}</strong> â†’ {{ action.outcome }}
              <br><small class="text-muted">{{ action.timestamp|date:"M d, Y H:i" }}</small>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <p>No actions yet. Try feeding, playing, or training!</p>
    {% endif %}
  </div>
</div>
{% endblock %}
